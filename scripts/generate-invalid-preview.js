#!/usr/bin/env node

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

function generateInvalidMarkdown(diagramType = 'flowchart') {
  const fixturesDir = path.resolve(__dirname, '..', 'test-fixtures', diagramType);
  const invalidDir = path.join(fixturesDir, 'invalid');
  
  if (!fs.existsSync(invalidDir)) {
    console.error(`No invalid fixtures found for diagram type: ${diagramType}`);
    process.exit(1);
  }
  
  const invalidFiles = fs.readdirSync(invalidDir)
    .filter(f => f.endsWith('.mmd'))
    .sort();
  
  let markdown = `# Invalid ${diagramType.charAt(0).toUpperCase() + diagramType.slice(1)} Diagrams

This file contains all invalid ${diagramType} test fixtures with their GitHub render attempts.
These diagrams demonstrate various syntax errors and how GitHub's Mermaid renderer handles them.

> **Note**: This file is auto-generated by \`scripts/generate-invalid-preview.js\`. Do not edit manually.
> 
> âš ï¸ **Warning**: These diagrams are intentionally invalid. They may:
> - Not render at all (showing error messages)
> - Render incorrectly or partially
> - Cause unexpected visual results

## Table of Contents

`;

  // Generate table of contents
  invalidFiles.forEach((file, index) => {
    const name = file.replace('.mmd', '').replace(/-/g, ' ');
    const title = name.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    markdown += `${index + 1}. [${title}](#${index + 1}-${file.replace('.mmd', '').toLowerCase()})\n`;
  });
  
  markdown += `\n---\n\n`;
  
  // Generate diagram sections
  invalidFiles.forEach((file, index) => {
    const filePath = path.join(invalidDir, file);
    const content = fs.readFileSync(filePath, 'utf-8');
    const name = file.replace('.mmd', '').replace(/-/g, ' ');
    const title = name.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    
    markdown += `## ${index + 1}. ${title}\n\n`;
    markdown += `ðŸ“„ **Source**: [\`${file}\`](./invalid/${file})\n\n`;
    
    // Add error descriptions
    const errorDescriptions = {
      'duplicate-subgraph': 'âŒ **Error**: Duplicate subgraph IDs are not allowed.',
      'empty-diagram': 'âŒ **Error**: Diagram must contain at least one statement after declaration.',
      'invalid-arrow': 'âŒ **Error**: Single arrow `->` is invalid. Use `-->` instead.',
      'invalid-class': 'âŒ **Error**: Class statement requires both node ID(s) and class name.',
      'invalid-node-syntax': 'âŒ **Error**: Incomplete node syntax with unclosed brackets.',
      'invalid-subgraph': 'âŒ **Error**: Subgraph must have an ID or title.',
      'missing-arrow': 'âŒ **Error**: Nodes on the same line must be connected with arrows.',
      'mixed-brackets': 'âŒ **Error**: Mixing bracket types like `[text)` is not allowed.',
      'no-diagram-type': 'âŒ **Error**: Diagram must start with `graph` or `flowchart`.',
      'special-chars': 'âŒ **Error**: Escaped quotes with backslash not supported in node labels.',
      'unclosed-bracket': 'âŒ **Error**: All brackets must be properly closed.',
      'unmatched-end': 'âŒ **Error**: `end` keyword without matching `subgraph`.',
      'wrong-direction': 'âŒ **Error**: Invalid direction. Must be one of: TD, TB, BT, RL, LR.'
    };
    
    const key = file.replace('.mmd', '');
    if (errorDescriptions[key]) {
      markdown += `${errorDescriptions[key]}\n\n`;
    }
    
    // Add the Mermaid diagram (even though it's invalid, to see how GitHub renders it)
    markdown += `### GitHub Render Attempt\n\n`;
    markdown += `> **Note**: This invalid diagram may not render or may render incorrectly.\n\n`;
    markdown += `\`\`\`mermaid\n${content}\n\`\`\`\n\n`;
    
    // Add collapsible source code section
    markdown += `<details>\n`;
    markdown += `<summary>View source code</summary>\n\n`;
    markdown += `\`\`\`\n${content}\n\`\`\`\n`;
    markdown += `</details>\n\n`;
    
    markdown += `---\n\n`;
  });
  
  // Add footer
  markdown += `## Validation Status

All diagrams in this file are confirmed to be invalid by:
- âŒ Our Mermaid linter (correctly rejects)
- âŒ Official mermaid-cli (correctly rejects)

Last generated: ${new Date().toISOString()}

## How to Regenerate

\`\`\`bash
node scripts/generate-invalid-preview.js ${diagramType}
\`\`\`
`;
  
  return markdown;
}

function main() {
  const diagramType = process.argv[2] || 'flowchart';
  const outputPath = path.resolve(__dirname, '..', 'test-fixtures', diagramType, 'INVALID_DIAGRAMS.md');
  const invalidDir = path.resolve(__dirname, '..', 'test-fixtures', diagramType, 'invalid');
  
  console.log(`Generating invalid preview for ${diagramType} diagrams...`);
  
  const markdown = generateInvalidMarkdown(diagramType);
  
  fs.writeFileSync(outputPath, markdown);
  
  const invalidFiles = fs.readdirSync(invalidDir).filter(f => f.endsWith('.mmd'));
  
  console.log(`âœ… Generated invalid preview at: ${outputPath}`);
  console.log(`ðŸ“Š Total invalid diagrams: ${invalidFiles.length}`);
}

main();